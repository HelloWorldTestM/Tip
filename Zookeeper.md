## ZooKeeper
### ACID
* **A** 原子性
* **C** 一致性
* **I** 隔离性
* **D** 持久性

### CAP
* **C 一致性** 在分布式系统中，如果针对一个数据项的更新操作执行成功后，所有用户都能够读取到最新的值，那么这样的系统可以认为是强一致性。
* **A 可用性** 系统提供的服务必须一致处于可用的状态，对于用户的每一个操作请求总是能够在有限的时间内返回结果。
* **P 分区容错性** 分布式系统在遇到任何网络分区故障的时候，仍然需要能够对外提供满足的一致性和可用性服务

# ZAP协议

```
ZAB协议并不像Paxos算法那样，是一种通用的分布式一致算法，他是一种特别为Zookpeer设计的崩溃可恢复的原子消息广播算法。 
```
Zookeeper使用**一个单一的主进程**来接受并处理客户端的所有事务请求，并采用ZAB的原子广播协议，将服务器数据的状态变更以Proposal的形式广播到所有的副本进程上去，ZAB协议的这个主备架构保证了同一时刻只有一个主进程来广播服务器状态的变更。

> ZK被设计成只允许唯一的Leader服务器进行来进行事务请求的处理，Leader服务器接收到客户端的事务请求后，会生成对应的事务提案，并发起一轮广播协议；而如果集群中的其他机器接收到客户端的事务请求，那么这些非leader服务器就会将这个事务请求转发给leader服务器。

ZAB协议包含两种基本的模式，分别是``崩溃恢复``和``消息广播``。

1. ``崩溃恢复``
	* ``进入恢复模式的触发条件``。当整个服务框架在启动过程中，或是当Leader服务器出现**网络中断**、**崩溃退出**与**重启**等异常状况时，ZAB协议就会进入恢复模式，并选举产生新的Leader服务器。
	* ``恢复模式退出条件``。Leader机器产生，并且已经有过半的机器与leader进行了同步，之后就进入``消息广播阶段``。
	
	> ps: 当一台服务器启动后并加入到集群中时，新加入的机器就会自动进入崩溃恢复模式。

2. ``消息广播``
	* 在消息广播的过程中，Leader服务器会为每一个follower服务器各自分配一个单独的队列，然后将需要广播的事务Proposal依次放入这些队列中去，并根据FIFO策略进行消息发送。每一个follower服务器在接收到这个事务的proposal之后，都会首先将其以事务的形式写入到本地磁盘中去，并且在写入成功后反馈给leader服务器一个Ack响应。当leader服务器接收到超过半数的Follower的Ack响应之后，就会广播一个Commit消息给所有的Follower服务器以通知其进行事务提交，同时leader自身也会完成对事务的提交。
